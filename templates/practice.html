<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Practice Editor</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        header { padding: 10px 16px; border-bottom: 1px solid #eee; display: flex; gap: 12px; align-items: center; }
        #main { display: grid; grid-template-rows: 1fr 180px; height: calc(100vh - 52px); }
        #editor { width: 100%; }
        #output { border-top: 1px solid #eee; display: grid; grid-template-columns: 1fr 1fr; }
        #preview { width: 100%; border: none; }
        #console { padding: 8px; font-family: Consolas, monospace; font-size: 13px; white-space: pre-wrap; overflow: auto; border-left: 1px solid #eee; }
        select, button { padding: 6px 10px; }
        .spacer { flex: 1; }
        .muted { color: #666; font-size: 12px; }
    </style>
    <script>
        const STORAGE_KEY_CODE = 'practice.editor.code';
        const STORAGE_KEY_LANG = 'practice.editor.lang';
        function saveLocal(key, value) { try { localStorage.setItem(key, value); } catch(_){} }
        function loadLocal(key, def='') { try { return localStorage.getItem(key) ?? def; } catch(_) { return def; } }
    </script>
    <script>var require = { paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } };</script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>
</head>
<body>
    <header>
        <strong>Practice Editor</strong>
        <label>Language
            <select id="language">
                <option value="javascript">JavaScript</option>
                <option value="typescript">TypeScript</option>
                <option value="python">Python</option>
                <option value="json">JSON</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
            </select>
        </label>
        <div class="spacer"></div>
        <span id="runNotice" class="muted">JS/HTML/CSS can run client-side</span>
        <button id="run">Run</button>
        <button id="format">Format</button>
        <button id="clear">Clear</button>
    </header>
    <div id="main">
        <div id="editor"></div>
        <div id="output">
            <iframe id="preview" sandbox="allow-scripts"></iframe>
            <div id="console"></div>
        </div>
    </div>

    <script>
    let editor;
    const initialLang = loadLocal(STORAGE_KEY_LANG, 'javascript');
    document.getElementById('language').value = initialLang;

    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: loadLocal(STORAGE_KEY_CODE, ''),
            language: initialLang,
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false }
        });

        editor.onDidChangeModelContent(() => {
            saveLocal(STORAGE_KEY_CODE, editor.getValue());
        });

        document.getElementById('language').addEventListener('change', (e) => {
            const lang = e.target.value;
            monaco.editor.setModelLanguage(editor.getModel(), lang);
            saveLocal(STORAGE_KEY_LANG, lang);
            updateRunNotice(lang);
        });

        document.getElementById('format').addEventListener('click', () => {
            if (editor) {
                editor.getAction('editor.action.formatDocument').run();
            }
        });

        document.getElementById('clear').addEventListener('click', () => {
            editor.setValue('');
            saveLocal(STORAGE_KEY_CODE, '');
        });

        document.getElementById('run').addEventListener('click', runCode);

        updateRunNotice(initialLang);
    });
    
    function updateRunNotice(lang) {
        const notice = document.getElementById('runNotice');
        if (['javascript', 'html', 'css'].includes(lang)) {
            notice.textContent = 'JS/HTML/CSS run in the sandbox below';
        } else if (lang === 'python') {
            notice.textContent = 'Python runs on the server with a short timeout';
        } else {
            notice.textContent = 'Execution requires a backend. Ask to enable runner.';
        }
    }

    function runCode() {
        const lang = document.getElementById('language').value;
        const code = editor.getValue();
        const iframe = document.getElementById('preview');
        const consoleView = document.getElementById('console');
        consoleView.textContent = 'Running...';

        if (lang === 'javascript') {
            const html = `<!doctype html><html><head><meta charset=\"utf-8\"></head><body><script>\n` +
                         wrapConsoleForwarder() +
                         `\ntry {` + code + `} catch(e){ console.error(e && (e.stack || e.toString())); }\nwindow.parent.postMessage({type:'practice-console', level:'info', args:['\u2713 Finished']}, '*');<\/script></body></html>`;
            writeIframe(iframe, html);
        } else if (lang === 'html') {
            const html = `<!doctype html><html><head><meta charset="utf-8"></head><body>` + code + `</body></html>`;
            writeIframe(iframe, html);
        } else if (lang === 'css') {
            const html = `<!doctype html><html><head><meta charset="utf-8"><style>` + code + `</style></head><body><h4 style="font-family:sans-serif">CSS Preview</h4><p>Edit CSS to see styles.</p></body></html>`;
            writeIframe(iframe, html);
        } else if (lang === 'python') {
            fetch('/run/python', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            }).then(r => r.json()).then(resp => {
                const parts = [];
                if (resp.stdout) parts.push('[stdout]\n' + resp.stdout.trim());
                if (resp.stderr) parts.push('[stderr]\n' + resp.stderr.trim());
                if (!resp.ok && resp.error) parts.push('[error]\n' + resp.error);
                const out = parts.join('\n\n') || (resp.ok ? 'âœ“ Finished (no output)' : 'No output');
                consoleView.textContent = out;
                writeIframe(iframe, `<!doctype html><html><body style="font-family:sans-serif; padding:8px">Python does not render a visual preview. See console for output.</body></html>`);
            }).catch(err => {
                consoleView.textContent = 'Runner error: ' + (err && err.message ? err.message : String(err));
            });
        } else {
            consoleView.textContent = 'Runner not available for this language. Ask to enable backend execution.';
            writeIframe(iframe, `<!doctype html><html><body style="font-family:sans-serif">No preview for this language.</body></html>`);
        }

        function writeIframe(ifr, html) {
            // Use srcdoc for reliability across browsers
            try {
                ifr.srcdoc = html;
            } catch (_) {
                const doc = ifr.contentDocument || ifr.contentWindow.document;
                doc.open();
                doc.write(html);
                doc.close();
            }
        }

        function wrapConsoleForwarder() {
            return `
            (function(){
                const queue = [];
                function send(type, args){
                    parent.postMessage({ type: 'practice-console', level: type, args: args.map(String) }, '*');
                }
                ['log','error','warn','info'].forEach(function(level){
                    const orig = console[level];
                    console[level] = function(){ try { send(level, Array.from(arguments)); } catch(_){}; orig.apply(console, arguments); };
                });
                window.addEventListener('error', function(e){
                    try { send('error', [e.message + ' @ ' + (e.filename||'') + ':' + (e.lineno||'')]); } catch(_){}
                });
            })();`;
        }
    }

    window.addEventListener('message', function(e){
        const consoleView = document.getElementById('console');
        const data = e.data || {};
        if (data.type === 'practice-console') {
            const line = `[${data.level}] ` + (data.args || []).join(' ');
            consoleView.textContent += (consoleView.textContent ? '\n' : '') + line;
        }
    });
    </script>
</body>
</html>


