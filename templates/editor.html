<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Session {{ session_id }}</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-light: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --border: #2a3342;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .topbar { display: flex; justify-content: space-between; padding: 10px 16px; background: #111827; border-bottom: 1px solid var(--border); }
    .brand { display: flex; gap: 10px; }
    .session-code { background: #1f2937; padding: 4px 8px; border-radius: 6px; }
    .actions { display: flex; gap: 8px; }
    .container { display: flex; height: calc(100vh - 50px); }
    .left { flex: 1; display: flex; flex-direction: column; }
    #editor { flex: 1; border-bottom: 1px solid var(--border); }
    .toolbar { padding: 8px; background: #111827; }
    .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: #1f2937; color: var(--text); cursor: pointer; }
    .btn.primary { background: #2563eb; border-color: #2563eb; }
    #output { padding: 10px; background: #0b1220; border-top: 1px solid var(--border); min-height: 80px; white-space: pre-wrap; font-family: monospace; }
    #participantsDrawer { width: 320px; border-left: 1px solid var(--border); background: #0b1220; display: flex; flex-direction: column; transition: transform 0.3s ease; transform: translateX(100%); }
    #participantsDrawer.open { transform: translateX(0); }
    #plist { list-style: none; margin: 0; padding: 12px; flex: 1; overflow-y: auto; }
    #plist li { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; background: #111827; }
    .p-info { display: flex; flex-direction: column; }
    .p-name { font-weight: 500; }
    .p-role { font-size: 12px; color: var(--muted); }
    .p-actions button { margin-left: 6px; padding: 4px 8px; font-size: 12px; border-radius: 6px; border: 1px solid #2a3b52; background: #1e293b; color: #e5e7eb; cursor: pointer; }
    .p-actions button:hover { background: #2563eb; border-color: #2563eb; }
    #writerBanner { text-align: center; padding: 6px; font-weight: bold; background: #1e3a8a; color: #fff; display: none; }
    #micControls { padding: 8px; background: #111827; display: flex; align-items: center; gap: 10px; }
    #micButton.active { background: red; }
    #micLevel { width: 200px; height: 10px; background: #333; border-radius: 4px; overflow: hidden; }
    #micLevelFill { height: 100%; width: 0; background: #3b82f6; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="session-code">Session {{ session_id }}</span>
      <span class="badge">Python</span>
    </div>
    <div class="actions"><button id="participantsBtn" class="btn">Participants</button></div>
  </div>

  <div id="writerBanner">‚úè You are the Writer</div>

  <div class="container">
    <div class="left">
      <div id="editor"></div>
      <div class="toolbar">
        <button id="runBtn" class="btn primary">Run</button>
        <button id="clearBtn" class="btn">Clear</button>
      </div>
      <div id="output"></div>
      <div id="inputArea" style="padding:10px; background:#111827; display:none;">
        <input id="inputBox" type="text" placeholder="Type input..." style="width:100%;" />
      </div>
      <div id="micControls">
        <button id="micButton" class="btn">üé§ Mic Off</button>
        <div id="micLevel"><div id="micLevelFill"></div></div>
      </div>
    </div>
    <div id="participantsDrawer">
      <h3 style="padding:12px; margin:0; border-bottom:1px solid var(--border);">Participants</h3>
      <ul id="plist"></ul>
    </div>
  </div>

  <script>
    const socket = io();
    const sessionId = "{{ session_id }}";
    const urlParams = new URLSearchParams(window.location.search);
    const myName = urlParams.get("name") || "Anonymous";

    let mySid = null, writerId = null, editor, running = false;
    let localStream = null, pcPeers = {};
    let audioContext, analyser, dataArray;

    // ================== MONACO ==================
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: "", language: "python", theme: "vs-dark", automaticLayout: true, readOnly: true
      });
      editor.onDidChangeModelContent(() => {
        if (mySid && mySid === writerId) socket.emit("code_change", { session_id: sessionId, content: editor.getValue() });
      });
    });

    socket.emit("join_session", { session_id: sessionId, name: myName });
    socket.on("connect", () => { mySid = socket.id; });

    socket.on("participants_update", data => {
      writerId = data.writer_id;
      if (editor) editor.updateOptions({ readOnly: mySid !== writerId });
      document.getElementById("writerBanner").style.display = (mySid === writerId) ? "block" : "none";
    });

    // ================== MIC + WEBRTC ==================
    const micButton = document.getElementById("micButton");
    const micLevelFill = document.getElementById("micLevelFill");

    micButton.onclick = async () => {
      if (micButton.classList.contains("active")) stopMic();
      else await startMic();
    };

    async function startMic() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micButton.classList.add("active"); micButton.textContent = "üé§ Mic On";

        audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(localStream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        requestAnimationFrame(updateMicLevel);

        socket.emit("webrtc_join", { session_id: sessionId });
        socket.emit("request_audio_peers", { session_id: sessionId });
      } catch (err) { console.error("Mic error", err); }
    }

    function stopMic() {
      if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
      micButton.classList.remove("active"); micButton.textContent = "üé§ Mic Off";
    }

    function updateMicLevel() {
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      let avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
      micLevelFill.style.width = (avg / 2) + "px";
      requestAnimationFrame(updateMicLevel);
    }

    async function createPeerConnection(peerId) {
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "turn:relay1.expressturn.com:3478", username: "efault", credential: "password" },
          { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" }
        ]
      });
      pcPeers[peerId] = pc;

      pc.onicecandidate = (event) => {
        if (event.candidate) socket.emit("webrtc_ice_candidate", { target: peerId, candidate: event.candidate });
      };
      pc.ontrack = (event) => {
        let audioElem = document.getElementById("remoteAudio_" + peerId);
        if (!audioElem) {
          audioElem = document.createElement("audio");
          audioElem.id = "remoteAudio_" + peerId;
          audioElem.autoplay = true;
          audioElem.playsInline = true;
          document.body.appendChild(audioElem);
        }
        console.log("üéß Remote audio from peer:", peerId);
        audioElem.srcObject = event.streams[0];
      };
      return pc;
    }

    socket.on("new_peer", async (data) => {
      const peerId = data.sid;
      if (!localStream) return;
      const pc = await createPeerConnection(peerId);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("webrtc_offer", { target: peerId, sdp: pc.localDescription });
    });

    socket.on("audio_peers_list", async (data) => {
      for (const peerId of data.peers) {
        const pc = await createPeerConnection(peerId);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("webrtc_offer", { target: peerId, sdp: pc.localDescription });
      }
    });

    socket.on("webrtc_offer", async (data) => {
      const { sid, sdp } = data;
      const pc = await createPeerConnection(sid);
      if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("webrtc_answer", { target: sid, sdp: pc.localDescription });
    });

    socket.on("webrtc_answer", async (data) => {
      const { sid, sdp } = data;
      const pc = pcPeers[sid];
      if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    });

    socket.on("webrtc_ice_candidate", async (data) => {
      const { sid, candidate } = data;
      const pc = pcPeers[sid];
      if (pc && candidate) {
        try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); }
        catch (err) { console.error("ICE error", err); }
      }
    });
  </script>
</body>
</html>
